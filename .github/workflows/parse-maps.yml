name: Parse RustMaps

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

on:
  schedule:          # Every 15 min
    - cron: '0 8 * * *' 
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - '.github/workflows/parse-maps.yml'

jobs:
  parse-maps:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # push required

    steps:
    #--- preparation ----------------------------------------------------------
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0        # otherwise push might fail

    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 \
          libxdamage1 libxrandr2 libgbm1 libxss1 libasound2t64 libgtk-3-0

    - name: Install npm deps (3 attempts)
      run: |
        for i in {1..3}; do
          echo "npm ci attempt #$i"
          npm ci --prefer-offline --no-audit && break
          [[ $i == 3 ]] && exit 1
          sleep 10
        done

    - name: Build project
      run: npm run build

    #--- run parser for exactly 6000 s -----------------------------------------
    - name: Parse maps (stop at 100 s)
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }} # Changed to DISCORD_WEBHOOK
        STEAM_KEY: ${{ secrets.STEAM_KEY }} # Added STEAM_KEY
        FACEPUNCH_UPLOAD_ENABLED: 'true'
      run: |
        set +e                         # do not terminate job on exit 124
        timeout 100 npm start         # Removed 'scan' argument
        code=$?
        if [ $code -eq 124 ]; then     # 124 -> timeout, this is "success"
          echo "Parser stopped after 100 s as intended."
          code=0
        fi
        exit $code

    #--- commit results -----------------------------------------------
    - name: Detect changes
      id: changes
      if: always()                     # even after timeout
      run: |
        git add -A data/               # Changed to data/
        if git diff --cached --quiet; then
          echo "changed=false" >> "$GITHUB_OUTPUT"
        else
          echo "changed=true"  >> "$GITHUB_OUTPUT"
        fi

    - name: Commit & push
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name  "GitHub Action"
        git commit -m "ðŸ¤– Update rustmaps cache $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || true
        git pull --rebase --autostash      # protect against race with next run
        git push

    #--- artifact ------------------------------------------------------------
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rustmaps-cache
        path: data/maps.json           # Changed to data/maps.json
        retention-days: 30 
